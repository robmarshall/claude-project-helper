# Project Structure

## Quick Reference

```
backend/
├── src/
│   ├── index.ts              # Entry point - starts server
│   ├── app.ts                # Hono app with all routes
│   ├── env.ts                # Zod-validated environment
│   ├── config/
│   │   ├── database.ts       # PostgreSQL/Drizzle connection
│   │   └── redis.ts          # Redis/IORedis connection
│   ├── db/
│   │   ├── index.ts          # Re-exports database connection
│   │   ├── schema/
│   │   │   ├── index.ts      # Re-exports all schemas
│   │   │   ├── users.ts      # User-related tables
│   │   │   ├── organisations.ts
│   │   │   └── [domain].ts   # Domain-specific tables
│   │   └── migrations/       # Generated by drizzle-kit
│   ├── routes/
│   │   ├── health.ts         # Health check endpoint
│   │   ├── auth.ts           # Auth routes (better-auth)
│   │   ├── stripe-webhook.ts # Webhook handlers
│   │   ├── v1/               # Public API (API key auth)
│   │   │   ├── index.ts      # v1 route aggregation
│   │   │   ├── openapi.ts    # Swagger UI + OpenAPI config
│   │   │   ├── openapi-schemas.ts  # All v1 request/response schemas
│   │   │   ├── projects/     # Resource grouping
│   │   │   └── handlers/     # Business logic handlers
│   │   ├── admin/            # Admin panel (Session auth)
│   │   │   ├── organisations.ts
│   │   │   ├── projects.ts
│   │   │   └── messages.ts
│   │   └── superadmin/       # Superadmin only (requires isAdmin)
│   │       └── index.ts
│   ├── middleware/
│   │   ├── api-key-auth.ts   # API key validation (v1 routes)
│   │   ├── session-auth.ts   # Session-based auth (admin routes)
│   │   ├── org-validation.ts # Organization membership check
│   │   ├── project-validation.ts  # Project access check
│   │   ├── superadmin-auth.ts     # Admin flag check
│   │   └── usage-limit.ts    # Subscription limits check
│   ├── services/
│   │   ├── api-key-service.ts      # Simple flat file services
│   │   ├── organisation-service.ts
│   │   ├── signature-service.ts
│   │   ├── queue/                  # Complex domain folder
│   │   │   ├── queue-manager.ts
│   │   │   └── webhook-processor.ts
│   │   ├── stripe/                 # External integration grouping
│   │   │   ├── stripe-client.ts
│   │   │   ├── subscription-manager.ts
│   │   │   └── plan-config.ts
│   │   └── workflow/               # Complex domain with types
│   │       ├── index.ts
│   │       ├── workflow-engine.ts
│   │       └── types.ts
│   ├── queue/
│   │   ├── manager.ts        # Queue initialization
│   │   ├── queues.ts         # Queue definitions
│   │   └── processors/
│   │       └── [job-type].ts # Job processors
│   └── lib/
│       └── auth.ts           # better-auth configuration only
├── drizzle.config.ts
├── tsup.config.ts
├── vitest.config.ts
└── package.json
```

## Three-Tier Route Organization

Routes are organized by authentication type:

| Tier | Path | Auth | Handler Location |
|------|------|------|------------------|
| v1 (Public API) | `/v1/*` | API key | `routes/v1/handlers/` |
| admin | `/admin/*` | Session | Inline in route files |
| superadmin | `/superadmin/*` | Session + isAdmin | Inline in route files |

## Naming Conventions

### Files

| Type | Convention | Example |
|------|------------|---------|
| Simple service | `kebab-case.ts` | `api-key-service.ts` |
| Complex service folder | `kebab-case/` | `workflow/`, `stripe/` |
| Middleware | `kebab-case.ts` | `api-key-auth.ts`, `session-auth.ts` |
| Route file | `kebab-case.ts` | `organisations.ts`, `stripe-webhook.ts` |
| Handler file | `kebab-case.handler.ts` | `messages.handler.ts` |

### Code

| Type | Convention | Example |
|------|------------|---------|
| Tables | `camelCase` | `queueItems`, `apiKeys` |
| Routes | `kebab-case` | `/api/queue-items` |
| Functions | `camelCase` | `createQueueItem()` |
| Types/Interfaces | `PascalCase` | `QueueItem`, `CreateUserInput` |
| Constants | `UPPER_SNAKE_CASE` | `MAX_RETRY_COUNT` |
| Env vars | `UPPER_SNAKE_CASE` | `DATABASE_URL` |

## Entry Point Pattern

```typescript
// src/index.ts
import { serve } from "@hono/node-server";
import { app } from "./app";
import { env } from "./env";
import { redis } from "./config/redis";
import { closeQueues } from "./queue/manager";

async function main() {
  const server = serve({
    fetch: app.fetch,
    port: env.PORT,
  });

  console.log(`Server running on port ${env.PORT}`);

  // Graceful shutdown
  const shutdown = async () => {
    console.log("Shutting down...");
    await closeQueues();
    await redis.quit();
    server.close();
    process.exit(0);
  };

  process.on("SIGINT", shutdown);
  process.on("SIGTERM", shutdown);
}

main().catch(console.error);
```

## App Configuration Pattern

```typescript
// src/app.ts
import { OpenAPIHono } from "@hono/zod-openapi";
import { cors } from "hono/cors";
import { logger } from "hono/logger";
import { apiKeyAuth } from "./middleware/api-key-auth";
import { sessionAuth } from "./middleware/session-auth";
import { superadminAuth } from "./middleware/superadmin-auth";
import { v1Routes } from "./routes/v1";
import { adminRoutes } from "./routes/admin";
import { superadminRoutes } from "./routes/superadmin";

// HonoEnv type (inline, not in separate types folder)
type HonoEnv = {
  Variables: {
    user: { id: string; email: string; name: string };
    organisationId: string;
    projectId: string;
    isApiKey: boolean;
  };
};

export const app = new OpenAPIHono<HonoEnv>();
export type { HonoEnv };

// Global middleware
app.use("*", logger());
app.use("*", cors({ origin: ["http://localhost:3000"], credentials: true }));

// Health check (no auth)
app.get("/health", (c) => c.json({ status: "ok" }));

// Public API routes (API key auth)
app.use("/v1/*", apiKeyAuth);
app.route("/v1", v1Routes);

// Admin routes (session auth)
app.use("/admin/*", sessionAuth);
app.route("/admin", adminRoutes);

// Superadmin routes (session + admin flag)
app.use("/superadmin/*", sessionAuth, superadminAuth);
app.route("/superadmin", superadminRoutes);
```

## Config Folder Pattern

```typescript
// src/config/database.ts
import { drizzle } from "drizzle-orm/postgres-js";
import postgres from "postgres";
import { env } from "../env";
import * as schema from "../db/schema";

const client = postgres(env.DATABASE_URL);
export const db = drizzle(client, { schema });

// src/config/redis.ts
import Redis from "ioredis";
import { env } from "../env";

export const redis = new Redis(env.REDIS_URL);
```

## Services Organization

Use **flat files** for simple services, **folders** for complex domains:

```
services/
├── api-key-service.ts         # Simple: single responsibility
├── organisation-service.ts    # Simple: CRUD + basic logic
├── queue/                     # Complex: multiple related files
│   ├── queue-manager.ts
│   └── webhook-processor.ts
├── stripe/                    # Integration: external service grouping
│   ├── stripe-client.ts
│   └── subscription-manager.ts
└── workflow/                  # Complex: domain with types
    ├── index.ts
    ├── workflow-engine.ts
    └── types.ts
```

## Types Location

Types are NOT in a separate `types/` folder. Instead:

- **Drizzle types**: Inferred from schema (`typeof table.$inferSelect`)
- **Hono env types**: In `app.ts` (exported for use elsewhere)
- **Service types**: Part of service files or `services/[domain]/types.ts`

```typescript
// Infer types from Drizzle schema
import { users } from "~/db/schema";
type User = typeof users.$inferSelect;
type NewUser = typeof users.$inferInsert;

// Import HonoEnv from app.ts
import type { HonoEnv } from "~/app";
```

## Import Aliases

Configure path aliases in `tsconfig.json`:

```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "~/*": ["./src/*"]
    }
  }
}
```

Usage:

```typescript
import { db } from "~/config/database";
import { users } from "~/db/schema";
import { apiKeyAuth } from "~/middleware/api-key-auth";
```

## Related Documentation

- [Database Schema](../database/INDEX.md)
- [API Routes](../api/INDEX.md)
- [Middleware](../middleware/INDEX.md)
- [Services](../services/INDEX.md)
